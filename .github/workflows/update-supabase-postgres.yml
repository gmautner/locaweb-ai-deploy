# Update Supabase Postgres
#
# Checks Docker Hub for newer supabase/postgres 17.x tags and opens
# a PR when a newer version is found. Acts as a purpose-built dependabot
# for the pinned supabase/postgres version (ADR-025).
#
# Runs weekly on Monday at 08:00 UTC, or on-demand via workflow_dispatch.

name: Update Supabase Postgres

on:
  schedule:
    - cron: "0 8 * * 1"     # Monday 08:00 UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-update:
    name: Check for New Version
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect current version
        id: current
        run: |
          version=$(grep -oP 'SUPABASE_POSTGRES_VERSION: "\K[^"]+' .github/workflows/deploy.yml)
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "Current pinned version: **$version**" >> "$GITHUB_STEP_SUMMARY"

      - name: Query Docker Hub for latest 17.x tag
        id: latest
        run: |
          all_tags=""
          url="https://hub.docker.com/v2/repositories/supabase/postgres/tags?page_size=100"

          while [ -n "$url" ] && [ "$url" != "null" ]; do
            response=$(curl -sf "$url")
            page_tags=$(echo "$response" | jq -r '.results[].name')
            all_tags="${all_tags}${page_tags}"$'\n'
            url=$(echo "$response" | jq -r '.next')
          done

          latest=$(echo "$all_tags" \
            | grep -E '^17\.[0-9]+\.[0-9]+\.[0-9]+$' \
            | sort -V \
            | tail -1)

          echo "version=$latest" >> "$GITHUB_OUTPUT"
          echo "Latest Docker Hub tag: **$latest**" >> "$GITHUB_STEP_SUMMARY"

      - name: Compare versions
        id: compare
        run: |
          current="${{ steps.current.outputs.version }}"
          latest="${{ steps.latest.outputs.version }}"

          if [ "$current" = "$latest" ]; then
            echo "update=false" >> "$GITHUB_OUTPUT"
            echo "âœ… Already up to date ($current)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "update=true" >> "$GITHUB_OUTPUT"
            echo "ðŸ†• Update available: $current â†’ $latest" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Update pinned version
        if: steps.compare.outputs.update == 'true'
        run: |
          current="${{ steps.current.outputs.version }}"
          latest="${{ steps.latest.outputs.version }}"

          sed -i "s|SUPABASE_POSTGRES_VERSION: \"${current}\"|SUPABASE_POSTGRES_VERSION: \"${latest}\"|" \
            .github/workflows/deploy.yml

          sed -i "s|supabase/postgres:${current}|supabase/postgres:${latest}|g" \
            docs/architecture.md

      - name: Create PR
        if: steps.compare.outputs.update == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          current="${{ steps.current.outputs.version }}"
          latest="${{ steps.latest.outputs.version }}"
          branch="auto/supabase-postgres-${latest}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$branch"
          git add .github/workflows/deploy.yml docs/architecture.md
          git commit -m "Bump supabase/postgres ${current} â†’ ${latest}"
          git push -u origin "$branch"

          gh pr create \
            --title "Bump supabase/postgres ${current} â†’ ${latest}" \
            --body "$(cat <<EOF
          Automated version bump detected by the **Update Supabase Postgres** workflow.

          | | Version |
          |---|---|
          | **Current** | \`${current}\` |
          | **New** | \`${latest}\` |

          \`deploy.yml\` (env var) and \`docs/architecture.md\` have been updated.

          > Staying within major version 17, so this is a safe patch/minor bump (ADR-025).
          EOF
          )"

          gh pr merge --auto --squash "$branch"

          echo "ðŸ“¦ PR created and auto-merge enabled for \`$branch\`" >> "$GITHUB_STEP_SUMMARY"
